# ëª¨ë°”ì¼ ê²°ì œ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

## í˜„ì¬ ìƒí™©
1. âœ… ëª¨ë°”ì¼ ê²°ì œ ì‹œ PGì‚¬(ì´ë‹ˆì‹œìŠ¤) ìŠ¹ì¸ ì™„ë£Œ
2. âŒ ì•± ë³µê·€ ì‹œ "ê²°ì œ ì‹¤íŒ¨" í‘œì‹œ
3. âŒ DBì— ë³„ ì¶©ì „ì´ ì•ˆ ë¨

## ìˆ˜ì •ëœ ë‚´ìš©

### 1. PaymentComplete.jsx - í”„ë¡ íŠ¸ì—”ë“œ ê°œì„ 
- âœ… ëª¨ë“  URL íŒŒë¼ë¯¸í„° ë¡œê·¸ ì¶”ê°€
- âœ… PortOne V2 & V1 íŒŒë¼ë¯¸í„° ëª¨ë‘ ì§€ì›
- âœ… ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
- âœ… ë””ë²„ê¹…ìš© ì½˜ì†” ë¡œê·¸ ì¶”ê°€

### 2. purchase-stars Edge Function - ë°±ì—”ë“œ ê°œì„ 
- âœ… ë‹¨ê³„ë³„ ë¡œê·¸ ì¶”ê°€ (1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ 4ï¸âƒ£ 5ï¸âƒ£)
- âœ… PortOne API í˜¸ì¶œ ìƒì„¸ ë¡œê·¸
- âœ… ì¤‘ë³µ ê²°ì œ ë°©ì§€ ê°•í™”
- âœ… ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ 

## í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸

### âš ï¸ ì¤‘ìš”: PortOne API í‚¤ ì„¤ì •
ë°±ì—”ë“œì—ì„œ PortOne APIë¥¼ í˜¸ì¶œí•˜ë ¤ë©´ ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ê°€ **ë°˜ë“œì‹œ** ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:

```bash
PORTONE_API_KEY=your_api_key_here
PORTONE_API_SECRET=your_api_secret_here
```

#### ì„¤ì • ë°©ë²•

1. **ë¡œì»¬ ê°œë°œ í™˜ê²½** - `.dev.vars` íŒŒì¼ì— ì¶”ê°€:
   ```bash
   PORTONE_API_KEY=ì‹¤ì œ_API_í‚¤
   PORTONE_API_SECRET=ì‹¤ì œ_API_ì‹œí¬ë¦¿
   ```

2. **í”„ë¡œë•ì…˜ í™˜ê²½** - Supabase CLI:
   ```bash
   supabase secrets set PORTONE_API_KEY=ì‹¤ì œ_API_í‚¤
   supabase secrets set PORTONE_API_SECRET=ì‹¤ì œ_API_ì‹œí¬ë¦¿
   ```

3. **PortOne API í‚¤ ë°œê¸‰ ë°©ë²•**:
   - https://admin.portone.io/ ë¡œê·¸ì¸
   - [ê°œë°œì] > [API Keys] ë©”ë‰´
   - [ìƒˆ API í‚¤ ë°œê¸‰] í´ë¦­
   - API Keyì™€ API Secret ë³µì‚¬

## ë””ë²„ê¹… ë°©ë²•

### 1. ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸ (í”„ë¡ íŠ¸ì—”ë“œ)
ê²°ì œ ì™„ë£Œ í˜ì´ì§€ì—ì„œ F12 í‚¤ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ ì—´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤:

```
=== ê²°ì œ ì™„ë£Œ í˜ì´ì§€ ì§„ì… ===
ì „ì²´ URL: https://truefuture.kr/payment/complete?paymentId=...
ëª¨ë“  íŒŒë¼ë¯¸í„°: { paymentId: "...", ... }
V2 íŒŒë¼ë¯¸í„°: { paymentId: "...", code: null, errorMessage: null }
V1 íŒŒë¼ë¯¸í„°: { impUid: null, impSuccess: null, merchantUid: null, errorMsg: null }
```

### 2. Supabase Edge Function ë¡œê·¸ í™•ì¸ (ë°±ì—”ë“œ)

#### ë¡œì»¬ ê°œë°œ:
í„°ë¯¸ë„ì—ì„œ ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸

#### í”„ë¡œë•ì…˜:
```bash
supabase functions logs purchase-stars --limit 50
```

ë˜ëŠ” Supabase Dashboard:
- [Edge Functions] > [purchase-stars] > [Logs] íƒ­

ì˜ˆìƒ ë¡œê·¸:
```
=== purchase-stars í•¨ìˆ˜ ì‹œì‘ ===
ìš”ì²­ ë³¸ë¬¸: { imp_uid: "...", merchant_uid: "...", user_id: "..." }
âš ï¸ amountê°€ ì—†ì–´ì„œ PortOne APIë¡œ ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹œì‘
1ï¸âƒ£ PortOne ì¸ì¦ í† í° ë°œê¸‰ ì¤‘...
ì¸ì¦ ì„±ê³µ, í† í° ë°œê¸‰ë¨
2ï¸âƒ£ ê²°ì œ ì •ë³´ ì¡°íšŒ ì¤‘: order_...
ğŸ“¦ PortOne ê²°ì œ ì •ë³´: { status: "PAID", amount: { total: 1100 }, ... }
âœ… ê²°ì œ ê¸ˆì•¡ í™•ì¸ ì™„ë£Œ: 1100ì›
1ï¸âƒ£ ì¤‘ë³µ ê²°ì œ í™•ì¸: order_...
âœ… ì¤‘ë³µ ê²°ì œ ì•„ë‹˜
2ï¸âƒ£ íŒ¨í‚¤ì§€ ê²€ì¦: 1100ì›
âœ… íŒ¨í‚¤ì§€ í™•ì¸: { name: "ìœ ì„± (Meteor)", paid: 10, bonus: 0 }
3ï¸âƒ£ ì‚¬ìš©ì ì§€ê°‘ ì¡°íšŒ: ...
4ï¸âƒ£ ì§€ê°‘ ì—…ë°ì´íŠ¸ ì¤‘...
âœ… ì§€ê°‘ ì—…ë°ì´íŠ¸ ì™„ë£Œ
5ï¸âƒ£ ê±°ë˜ ë‚´ì—­ ê¸°ë¡ ì¤‘...
âœ… ê±°ë˜ ë‚´ì—­ ê¸°ë¡ ì™„ë£Œ
=== ì²˜ë¦¬ ì™„ë£Œ ===
```

## ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ì™€ í•´ê²° ë°©ë²•

### ì˜¤ë¥˜ 1: "ì„œë²„ ì„¤ì • ì˜¤ë¥˜: PortOne API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤"
**ì›ì¸**: `PORTONE_API_KEY` ë˜ëŠ” `PORTONE_API_SECRET` í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
1. PortOne ì½˜ì†”ì—ì„œ API í‚¤ ë°œê¸‰
2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ìœ„ "í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸" ì°¸ì¡°)
3. Edge Function ì¬ë°°í¬:
   ```bash
   supabase functions deploy purchase-stars
   ```

### ì˜¤ë¥˜ 2: "PortOne ì¸ì¦ ì‹¤íŒ¨ (401)"
**ì›ì¸**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë¨

**í•´ê²°**:
1. PortOne ì½˜ì†”ì—ì„œ API í‚¤ ì¬í™•ì¸
2. ì˜¬ë°”ë¥¸ í‚¤ë¡œ í™˜ê²½ ë³€ìˆ˜ ì¬ì„¤ì •

### ì˜¤ë¥˜ 3: "ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (404)"
**ì›ì¸**: ì˜ëª»ëœ `paymentId` ë˜ëŠ” í…ŒìŠ¤íŠ¸/í”„ë¡œë•ì…˜ í™˜ê²½ ë¶ˆì¼ì¹˜

**í•´ê²°**:
1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì „ì†¡í•œ `paymentId` í™•ì¸
2. PortOne ì½˜ì†”ì—ì„œ í•´ë‹¹ ê²°ì œ ê±´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
3. í…ŒìŠ¤íŠ¸ API í‚¤ëŠ” í…ŒìŠ¤íŠ¸ ê²°ì œë§Œ, í”„ë¡œë•ì…˜ API í‚¤ëŠ” ì‹¤ê²°ì œë§Œ ì¡°íšŒ ê°€ëŠ¥

### ì˜¤ë¥˜ 4: "ì´ë¯¸ ì²˜ë¦¬ëœ ê²°ì œì…ë‹ˆë‹¤"
**ì›ì¸**: ë™ì¼í•œ `paymentId`ë¡œ ì¤‘ë³µ í˜¸ì¶œë¨

**í•´ê²°**:
- ì •ìƒ ë™ì‘ì…ë‹ˆë‹¤ (ì¤‘ë³µ ì¶©ì „ ë°©ì§€)
- ì´ë¯¸ ë³„ì´ ì¶©ì „ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”

### ì˜¤ë¥˜ 5: "ìœ íš¨í•˜ì§€ ì•Šì€ ê²°ì œ ê¸ˆì•¡ì…ë‹ˆë‹¤"
**ì›ì¸**: PortOneì—ì„œ ì¡°íšŒí•œ ê¸ˆì•¡ì´ íŒ¨í‚¤ì§€ ê¸ˆì•¡ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ

**í•´ê²°**:
- í˜„ì¬ ì§€ì› ê¸ˆì•¡: 1100ì›, 3300ì›, 5500ì›, 11000ì›
- `PACKAGES` ê°ì²´ì— í•´ë‹¹ ê¸ˆì•¡ ì¶”ê°€ í•„ìš”

## ì´ë¯¸ ê²°ì œëœ ê±´ ì²˜ë¦¬ ë°©ë²•

### ìƒí™©: ê²°ì œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ë³„ì´ ì¶©ì „ë˜ì§€ ì•ŠìŒ

#### ë°©ë²• 1: ê²°ì œ IDë¡œ ìˆ˜ë™ ì¶©ì „ (ì¶”ì²œ)
1. Supabase Dashboard > SQL Editorì—ì„œ ë‹¤ìŒ ì¿¼ë¦¬ ì‹¤í–‰:

```sql
-- 1. í•´ë‹¹ ê²°ì œê°€ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
SELECT * FROM star_transactions 
WHERE related_item_id = 'ê²°ì œID' 
ORDER BY created_at DESC;

-- 2. ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìˆ˜ë™ ì¶©ì „
-- (user_id, ê¸ˆì•¡ ë“±ì„ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½)
BEGIN;

-- ì§€ê°‘ ì—…ë°ì´íŠ¸
INSERT INTO user_wallets (user_id, paid_stars, bonus_stars, updated_at)
VALUES ('ì‚¬ìš©ìID', 10, 0, NOW())
ON CONFLICT (user_id) 
DO UPDATE SET 
  paid_stars = user_wallets.paid_stars + 10,
  updated_at = NOW();

-- ê±°ë˜ ë‚´ì—­ ê¸°ë¡
INSERT INTO star_transactions (
  user_id, amount, type, description, 
  related_item_id, paid_amount, bonus_amount,
  expires_at, is_expired
) VALUES (
  'ì‚¬ìš©ìID', 10, 'CHARGE', 'íŒ¨í‚¤ì§€ êµ¬ë§¤: ìœ ì„± (Meteor) - ìˆ˜ë™ ì²˜ë¦¬',
  'ê²°ì œID', 10, 0,
  NOW() + INTERVAL '1 year', false
);

COMMIT;
```

#### ë°©ë²• 2: Edge Function ì¬í˜¸ì¶œ
í„°ë¯¸ë„ì—ì„œ ì§ì ‘ í˜¸ì¶œ:

```bash
curl -X POST https://your-project.supabase.co/functions/v1/purchase-stars \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -d '{
    "user_id": "ì‚¬ìš©ìID",
    "imp_uid": "ê²°ì œID"
  }'
```

## ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì‹œ í™•ì¸ì‚¬í•­

1. âœ… ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ URL íŒŒë¼ë¯¸í„° í™•ì¸
2. âœ… Edge Function ë¡œê·¸ì—ì„œ ë‹¨ê³„ë³„ ì§„í–‰ ìƒí™© í™•ì¸
3. âœ… PortOne API í‚¤ ì„¤ì • í™•ì¸
4. âœ… ê²°ì œ ì™„ë£Œ í›„ ë³„ ì”ì•¡ ë³€ê²½ í™•ì¸
5. âœ… `star_transactions` í…Œì´ë¸”ì— ê±°ë˜ ë‚´ì—­ ê¸°ë¡ í™•ì¸

## ì§€ì›

ë¬¸ì œê°€ ê³„ì†ë˜ë©´ ë‹¤ìŒ ì •ë³´ë¥¼ í•¨ê»˜ ì œê³µí•´ì£¼ì„¸ìš”:
- ë¸Œë¼ìš°ì € ì½˜ì†” ë¡œê·¸ ì „ì²´
- Edge Function ë¡œê·¸ (Supabase Dashboard)
- ê²°ì œ ID (paymentId ë˜ëŠ” imp_uid)
- ê²°ì œ ê¸ˆì•¡
- ì‚¬ìš©ì ID
